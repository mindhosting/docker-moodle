#
#
# WARNING!!
# DO NOT EDIT THIS FILE UNLESS YOU KNOW WHAT YOU'RE DOING
# ALL NECESSARY VARIABLES ARE EDITABLE FORM PORTAINER TEMPLATE
#
#

version: '2'

services:
  db:
    image: mysql:5.7.29
    restart: unless-stopped
    environment:
      MYSQL_DATABASE: $USERNAME
      MYSQL_USER: $USERNAME
      MYSQL_PASSWORD: $PASSWORD
      MYSQL_ROOT_PASSWORD: $DB_ROOT_PASSWORD
      TZ: Africa/Tunis
    volumes:
      - ./$DOMAIN_NAME/mysql:/var/lib/mysql
    network_mode: bridge
    
  moodle:
    image: mindhosting/moodle:latest
    depends_on:
      - db
    restart: unless-stopped
    links:
      - db:db
    volumes:
      - ./$DOMAIN_NAME/mysql:/web_data/db_data
      - ./$DOMAIN_NAME/web:/web_data/public_html
      - ./$DOMAIN_NAME/moodledata:/web_data/moodledata
    hostname: $DOMAIN_NAME
    environment:
      FILEMANAGER_ROOT_PATH: '/web_data/public_html'
      ADMIN_USERNAME: $USERNAME
      ADMIN_PASSWORD: $PASSWORD
      ADMIN_EMAIL: $EMAIL   
      TZ: $TIMEZONE
      VIRTUAL_HOST: $DOMAIN_NAME
      LETSENCRYPT_HOST: $DOMAIN_NAME
      LETSENCRYPT_EMAIL: mindengineering.tn@gmail.com

  duplicati:
    image: linuxserver/duplicati
    restart: unless-stopped
    environment:
      PUID: 1000
      PGID: 1000
      TZ: Africa/Tunis
      CLI_ARGS: #optional
      VIRTUAL_HOST: duplicati.$DOMAIN_NAME
      LETSENCRYPT_HOST: duplicati.$DOMAIN_NAME
      LETSENCRYPT_EMAIL: mindengineering.tn@gmail.com
      VIRTUAL_PORT: '8200'
    volumes:
      # DUPLICATI CONFIGURATION
      - ./$DOMAIN_NAME/duplicati:/config
      # TO CONTROLE DOCKER SOCK AND DOCKER TO STOP/START MYSQL CONTAINER BEFORE/AFTER BACKUP
      #- /var/run/docker.sock:/var/run/docker.sock
      #- /usr/bin/docker:/usr/bin/docker
      #- ./volumes/backup/script.sh:/usr/bin/script.sh
      # ACCESS TO VOLUME SOURCES
      - ./$DOMAIN_NAME/mysql:/source/db_data
      - ./$DOMAIN_NAME/web:/source/public_html
      - ./$DOMAIN_NAME/moodledata:/source/moodledata
      # BACKUP DISTINATION
      - ./$DOMAIN_NAME/backups:/backups
    hostname: duplicati.$DOMAIN_NAME
    network_mode: bridge

  phpmyadmin:
    image: phpmyadmin/phpmyadmin
    restart: unless-stopped
    depends_on:
      - db
    links:
      - db:db
    environment:
      MYSQL_USERNAME: root
      MYSQL_ROOT_PASSWORD: $DB_ROOT_PASSWORD
      PMA_HOST: db
      TZ: Africa/Tunis
      VIRTUAL_HOST: phpmyadmin.$DOMAIN_NAME
      LETSENCRYPT_HOST: phpmyadmin.$DOMAIN_NAME
      LETSENCRYPT_EMAIL: mindengineering.tn@gmail.com
    network_mode: bridge
